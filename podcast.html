<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ポッドキャスト台本 - Daily News Digest</title>
  <link rel="stylesheet" href="/static/base.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --podcast-accent: #2563EB;
      --podcast-closing: #E74C3C;
      --podcast-primary-btn: #2563EB;
      --podcast-bg-page: #F8F9FA;
      --podcast-bg-recap: #F1F3F5;
      --podcast-tag-bg: #1E40AF;
      --podcast-card-border: #E9ECEF;
    }
    body { font-family: "Noto Sans JP", "Hiragino Sans", "Yu Gothic", sans-serif; margin: 0; padding: 0; background: var(--podcast-bg-page); color: var(--app-text); }
    .main-wrap { max-width: 680px; margin: 0 auto; padding: 2rem var(--page-padding-home); }
    #message { margin-bottom: var(--gap-md); font-size: 0.875rem; color: #6C757D; }
    .card { background: #fff; border-radius: 14px; padding: 2.5rem 2.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: var(--gap-lg); border: 1px solid var(--podcast-card-border); }
    .card .title-block { text-align: center; margin-bottom: 2rem; padding-bottom: 0; }
    .page-title { font-size: 1.9rem; font-weight: 700; color: #212529; margin: 0 0 0.5rem; letter-spacing: -0.02em; }
    .meta { font-size: 0.9rem; color: #6C757D; margin-bottom: 0; font-weight: 400; }
    .script-body { font-size: 0.95rem; line-height: 1.85; }
    .script-body .segment { margin-bottom: 2rem; }
    .script-body .segment:last-of-type { margin-bottom: 0; }
    .script-body .segment-head { font-weight: 700; margin-bottom: 0.75rem; }
    /* OPENING: 左侧蓝色竖条 + 标题与正文对齐 */
    .script-body .segment.opening-block { background: #fff; border-radius: 10px; padding: 1.25rem 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.06); border-left: 5px solid var(--podcast-accent); margin-bottom: 2rem; }
    .script-body .segment.opening-block .segment-head.opening { color: var(--podcast-accent); text-transform: uppercase; letter-spacing: 0.06em; font-size: 0.95rem; margin-bottom: 0.75rem; border: none; padding: 0; }
    .script-body .segment.opening-block .segment-content { padding-left: 0; color: #495057; white-space: pre-wrap; border: none; font-size: 0.95rem; line-height: 1.85; }
    /* セグメント: 深蓝矩形标签 + 正文 */
    .script-body .segment-head.pill { background: var(--podcast-tag-bg); color: #fff; padding: 6px 14px; border-radius: 4px; display: inline-block; border: none; font-size: 0.85rem; font-weight: 600; }
    .script-body .segment-head.recap { font-weight: 600; color: #212529; font-size: 0.95rem; margin-bottom: 0.5rem; }
    .script-body .segment-content { color: #212529; white-space: pre-wrap; }
    .script-body .segment.recap-box .segment-content { background: var(--podcast-bg-recap); border-radius: 8px; padding: 1.25rem 1.5rem; border: none; }
    /* CLOSING: 红粉色 + 左侧细竖线 */
    .script-body .segment-head.closing { color: var(--podcast-closing); border-left: 4px solid var(--podcast-closing); padding-left: 0.75rem; margin-left: 0; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.95rem; }
    .actions { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--podcast-card-border); justify-content: center; }
    .actions .btn-primary { background: var(--podcast-primary-btn); color: #fff; border: none; padding: 10px 22px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-family: inherit; font-weight: 600; text-decoration: none; display: inline-block; box-shadow: 0 2px 6px rgba(37, 99, 235, 0.35); }
    .actions .btn-primary:hover { opacity: 0.92; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
    .actions .btn-secondary { background: #fff; color: #212529; border: 1px solid #ADB5BD; padding: 10px 22px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-family: inherit; font-weight: 500; }
    .actions .btn-secondary:hover { background: #F8F9FA; border-color: #6C757D; }
  </style>
</head>
<body>
  <header class="header">
    <a href="index.html" class="brand">原子新闻</a>
    <nav class="nav-top">
      <a href="index.html">ホーム</a>
      <a href="digest.html">ニュース概要</a>
      <a href="podcast.html" class="active">ポッドキャスト台本</a>
      <a href="sync_reader.html">同期朗読</a>
      <a href="japanese_points.html">日本語学習</a>
    </nav>
    <span id="auth-header"></span>
  </header>
  <script src="/static/auth.js"></script>
  <main class="main-wrap">
    <div class="toolbar">
      <label>日付 <input type="date" id="dateInput"></label>
      <button type="button" id="btnLoad">読み込む</button>
    </div>
    <div id="message" class="hint"></div>
    <div id="card" class="card" style="display: none;">
      <div class="title-block">
        <h1 class="page-title">ポッドキャスト台本</h1>
        <p class="meta" id="meta">日付: <span id="metaDate"></span> | ホスト: 美香</p>
      </div>
      <div id="content" class="script-body"></div>
      <div class="actions">
        <a href="#" id="btnTts" class="btn-primary" style="text-decoration: none; color: inherit;">音声を生成 (TTS)</a>
        <button type="button" id="btnSave" class="btn-secondary">Markdownとして保存</button>
      </div>
    </div>
  </main>

  <script>
(function () {
  const dateInput = document.getElementById("dateInput");
  const btnLoad = document.getElementById("btnLoad");
  const message = document.getElementById("message");
  const card = document.getElementById("card");
  const content = document.getElementById("content");
  const metaDate = document.getElementById("metaDate");
  const btnTts = document.getElementById("btnTts");
  const btnSave = document.getElementById("btnSave");

  const SEGMENT_LABELS = {
    "1. 开场": { style: "opening", label: "OPENING" },
    "2. 金融": { style: "pill", label: "金融セグメント" },
    "2. AI": { style: "pill", label: "AI セグメント" },
    "2. 中美关系": { style: "pill", label: "米中関係セグメント" },
    "2. 日本政治": { style: "pill", label: "日本政治セグメント" },
    "3. 本日总结": { style: "recap", label: "本日を振り返って", box: true },
    "4. 结束语": { style: "closing", label: "CLOSING" }
  };

  let currentDate = "";
  let rawText = "";

  function setMessage(msg, isError) {
    message.textContent = msg;
    message.className = isError ? "error" : "hint";
  }

  function escapeHtml(s) {
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  function parseScript(text) {
    const lines = text.split("\n");
    const sections = [];
    let i = 0;
    while (i < lines.length) {
      const line = lines[i];
      const m = line.match(/^##\s+(.+)$/);
      if (m) {
        const title = m[1].trim();
        const body = [];
        i++;
        while (i < lines.length && !lines[i].match(/^##\s+/)) {
          body.push(lines[i]);
          i++;
        }
        sections.push({ title: title, body: body.join("\n").trim() });
        continue;
      }
      i++;
    }
    return sections;
  }

  function renderScript(sections) {
    content.innerHTML = "";
    sections.forEach(function (sec) {
      const cfg = SEGMENT_LABELS[sec.title] || { style: "pill", label: sec.title };
      const seg = document.createElement("div");
      seg.className = "segment" + (cfg.box ? " recap-box" : "") + (cfg.style === "opening" ? " opening-block" : "");
      const head = document.createElement("div");
      head.className = "segment-head " + cfg.style;
      head.textContent = cfg.label;
      const body = document.createElement("div");
      body.className = "segment-content";
      body.textContent = sec.body;
      seg.appendChild(head);
      seg.appendChild(body);
      content.appendChild(seg);
    });
  }

  function loadScript() {
    const date = dateInput.value;
    if (!date) {
      setMessage("日付を選択してください。", true);
      return;
    }
    setMessage("読み込み中…");
    card.style.display = "none";
    fetch("/reports/podcast_script_" + date + ".md")
      .then(function (r) {
        if (!r.ok) throw new Error("この日付の台本がありません。python podcast.py --date " + date + " を先に実行してください。");
        return r.text();
      })
      .then(function (data) {
        rawText = data;
        currentDate = date;
        metaDate.textContent = date;
        const sections = parseScript(data);
        if (sections.length === 0) {
          content.innerHTML = "<div class=\"segment-content\" style=\"white-space: pre-wrap;\">" + escapeHtml(data) + "</div>";
        } else {
          renderScript(sections);
        }
        card.style.display = "block";
        btnTts.href = "sync_reader.html?date=" + date;
        setMessage(date + " を読み込みました。");
      })
      .catch(function (e) {
        if (e.message) setMessage(e.message, true);
        else setMessage("読み込みに失敗しました。", true);
      });
  }

  btnLoad.addEventListener("click", loadScript);
  btnSave.addEventListener("click", function () {
    if (!rawText || !currentDate) return;
    const blob = new Blob([rawText], { type: "text/markdown;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "podcast_script_" + currentDate + ".md";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  var d = new Date();
  d.setDate(d.getDate() - 1);
  dateInput.value = d.toISOString().slice(0, 10);
  loadScript();
})();
  </script>
</body>
</html>
