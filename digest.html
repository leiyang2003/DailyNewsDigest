<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ニュース概要 - Daily News Digest</title>
  <link rel="stylesheet" href="/static/base.css">
  <style>
    body { font-family: var(--font-sans-ja); margin: 0; padding: 0; background: #f0f0f0; color: var(--color-text); }
    .header { display: flex; align-items: center; justify-content: space-between; padding: var(--gap-lg) var(--page-padding-home); max-width: 960px; margin: 0 auto; background: #fff; }
    .brand { font-size: 2rem; font-weight: 700; color: #1e3a5f; }
    .nav-top { display: flex; gap: var(--gap-xl); flex-wrap: wrap; }
    .nav-top a { color: var(--color-text); text-decoration: none; font-size: var(--font-size-small); padding-bottom: 2px; border-bottom: 2px solid transparent; }
    .nav-top a:hover { color: var(--color-link); }
    .nav-top a.active { color: var(--color-link); border-bottom-color: var(--color-link); }
    .main { max-width: 960px; margin: 0 auto; padding: var(--gap-xl) var(--page-padding-home); }
    .page-title { font-size: 1.5rem; font-weight: 700; color: var(--color-text); margin: 0 0 var(--gap-lg); }
    .toolbar { display: flex; align-items: center; gap: var(--gap-md); flex-wrap: wrap; margin-bottom: var(--gap-lg); }
    .filters { display: flex; gap: var(--gap-sm); flex-wrap: wrap; margin-bottom: var(--gap-xl); }
    .filters button { padding: var(--gap-sm) var(--gap-md); border: none; border-radius: var(--radius-md); font-size: var(--font-size-small); cursor: pointer; background: var(--color-bg); color: var(--color-text); font-family: inherit; }
    .filters button:hover { background: var(--color-border-faint); }
    .filters button.active { background: var(--color-link); color: #fff; }
    #message { margin-bottom: var(--gap-md); font-size: var(--font-size-small); color: var(--color-hint); }
    .article-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--gap-xl); }
    .article-card { background: #fff; border: 1px solid var(--color-border-light); border-radius: var(--radius-md); padding: var(--gap-lg); box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .article-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--gap-sm); flex-wrap: wrap; gap: var(--gap-sm); }
    .article-tag { display: inline-block; padding: 0.2rem var(--gap-sm); border-radius: var(--radius-sm); background: var(--color-bg); color: var(--color-text-muted); font-size: var(--font-size-caption); }
    .article-date { font-size: var(--font-size-caption); color: var(--color-hint); }
    .article-title { font-size: var(--font-size-h2); font-weight: 600; color: var(--color-text); margin: 0 0 var(--gap-sm); line-height: 1.4; }
    .article-summary { font-size: var(--font-size-small); color: var(--color-text-muted); line-height: 1.5; margin: 0 0 var(--gap-md); word-break: break-word; overflow-wrap: break-word; }
    .article-summary a { color: var(--color-link); text-decoration: none; }
    .article-summary a:hover { text-decoration: underline; }
    .article-link { font-size: var(--font-size-small); color: var(--color-link); text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem; }
    .article-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header class="header">
    <span class="brand">原子新闻</span>
    <nav class="nav-top">
      <a href="index.html">ホーム</a>
      <a href="digest.html" class="active">ニュース概要</a>
      <a href="podcast.html">ポッドキャスト台本</a>
      <a href="sync_reader.html">同期朗読</a>
      <a href="japanese_points.html">日本語学習</a>
    </nav>
  </header>
  <main class="main">
    <h1 class="page-title">ニュース概要</h1>
    <div class="toolbar">
      <label>日付 <input type="date" id="dateInput"></label>
      <button type="button" id="btnLoad">読み込む</button>
    </div>
    <div id="message" class="hint"></div>
    <div class="filters" id="filters" style="display: none;">
      <button type="button" data-cat="all" class="active">すべて</button>
      <button type="button" data-cat="金融">金融</button>
      <button type="button" data-cat="AI">AI</button>
      <button type="button" data-cat="中美关系">米中関係</button>
      <button type="button" data-cat="日本政治">日本政治</button>
      <button type="button" data-cat="其他">その他</button>
    </div>
    <div id="content" class="article-grid"></div>
  </main>

  <script>
(function () {
  const dateInput = document.getElementById("dateInput");
  const btnLoad = document.getElementById("btnLoad");
  const message = document.getElementById("message");
  const content = document.getElementById("content");
  const filtersEl = document.getElementById("filters");

  const CAT_LABELS = { "金融": "金融", "AI": "AI", "中美关系": "米中関係", "日本政治": "日本政治", "其他": "その他" };
  let allItems = [];
  let reportDate = "";
  let currentFilter = "all";

  function setMessage(msg, isError) {
    message.textContent = msg;
    message.className = isError ? "error" : "hint";
  }

  function escapeHtml(s) {
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  function formatSummary(summary) {
    if (!summary) return "";
    const linkRe = /\[([^\]]*)\]\(([^)]*)\)/g;
    const parts = summary.split(linkRe);
    let out = "";
    for (let i = 0; i < parts.length; i++) {
      if (i % 3 === 0) {
        out += escapeHtml(parts[i]);
      } else if (i % 3 === 1) {
        const text = parts[i];
        const url = parts[i + 1] || "";
        out += "<a href=\"" + escapeHtml(url.trim()) + "\" target=\"_blank\" rel=\"noopener\">" + escapeHtml(text) + "</a>";
        i++;
      }
    }
    return out;
  }

  function renderCards(items) {
    content.innerHTML = "";
    items.forEach(function (it) {
      const cat = it.category || "其他";
      const label = CAT_LABELS[cat] || cat;
      const card = document.createElement("article");
      card.className = "article-card";
      card.innerHTML =
        "<div class=\"article-meta\"><span class=\"article-tag\">" + escapeHtml(label) + "</span><span class=\"article-date\">" + escapeHtml(reportDate) + "</span></div>" +
        "<h2 class=\"article-title\">" + escapeHtml(it.title || "") + "</h2>" +
        "<p class=\"article-summary\">" + formatSummary(it.summary || "") + "</p>" +
        "<a href=\"" + escapeHtml(it.url || "#") + "\" target=\"_blank\" rel=\"noopener\" class=\"article-link\">原文を読む <span aria-hidden=\"true\">↗</span></a>";
      content.appendChild(card);
    });
  }

  function applyFilter() {
    const items = currentFilter === "all" ? allItems : allItems.filter(function (it) { return (it.category || "其他") === currentFilter; });
    renderCards(items);
  }

  function loadData() {
    const date = dateInput.value;
    if (!date) {
      setMessage("日付を選択してください。", true);
      return;
    }
    setMessage("読み込み中…");
    content.innerHTML = "";
    filtersEl.style.display = "none";
    fetch("/reports/daily_digest_" + date.replace(/-/g, "_") + ".json")
      .then(function (r) {
        if (!r.ok) throw new Error("この日付のデータがありません。python digest.py --date " + date + " を先に実行してください。");
        return r.json();
      })
      .then(function (data) {
        allItems = data.items || [];
        reportDate = data.report_date || date;
        currentFilter = "all";
        filtersEl.style.display = "flex";
        filtersEl.querySelectorAll("button").forEach(function (btn) {
          btn.classList.toggle("active", btn.dataset.cat === "all");
        });
        setMessage(reportDate + " を読み込みました。" + allItems.length + " 件。");
        applyFilter();
      })
      .catch(function (e) {
        setMessage(e.message || "読み込みに失敗しました。", true);
      });
  }

  btnLoad.addEventListener("click", loadData);
  filtersEl.querySelectorAll("button").forEach(function (btn) {
    btn.addEventListener("click", function () {
      currentFilter = btn.dataset.cat;
      filtersEl.querySelectorAll("button").forEach(function (b) { b.classList.remove("active"); });
      btn.classList.add("active");
      applyFilter();
    });
  });

  var d = new Date();
  d.setDate(d.getDate() - 1);
  var y = d.getFullYear();
  var m = String(d.getMonth() + 1).padStart(2, "0");
  var day = String(d.getDate()).padStart(2, "0");
  dateInput.value = y + "-" + m + "-" + day;
  loadData();
})();
  </script>
</body>
</html>
