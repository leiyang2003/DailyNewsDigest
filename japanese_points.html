<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>日本語学習 - Daily News Digest</title>
  <link rel="stylesheet" href="/static/base.css">
  <style>
    body.page-jp { font-family: var(--font-sans-ja); margin: 0; padding: 0; background: var(--app-bg-page); color: var(--app-text); }
    .main { max-width: 960px; margin: 0 auto; padding: var(--gap-xl) var(--page-padding-home); }
    .title-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--gap-md); margin-bottom: var(--gap-md); }
    .page-title { font-size: 1.5rem; font-weight: 700; margin: 0; }
    .view-tabs { display: flex; gap: 0; }
    .view-tabs button { padding: var(--gap-sm) var(--gap-md); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: var(--font-size-small); cursor: pointer; background: #fff; color: var(--color-text-muted); font-family: inherit; margin-left: -1px; }
    .view-tabs button:first-child { margin-left: 0; border-radius: var(--radius-md) 0 0 var(--radius-md); }
    .view-tabs button:last-child { border-radius: 0 var(--radius-md) var(--radius-md) 0; }
    .view-tabs button:hover { background: var(--color-bg); }
    .view-tabs button.active { background: var(--app-accent); color: #fff; border-color: var(--app-accent); }
    .toolbar { display: flex; align-items: center; gap: var(--gap-md); flex-wrap: wrap; margin-bottom: var(--gap-md); }
    .toolbar-single { margin-bottom: var(--gap-md); }
    .toolbar-single button { padding: var(--gap-sm) var(--gap-lg); border-radius: var(--radius-md); font-size: var(--font-size-small); cursor: pointer; background: var(--app-accent); color: #fff; border: none; font-family: inherit; }
    .toolbar-single button:hover { opacity: 0.9; }
    #mainMessage { margin-bottom: var(--gap-md); font-size: var(--font-size-small); color: var(--color-hint); }
    .list-wrap { overflow-x: auto; }
    .table-section { font-size: var(--font-size-h2); font-weight: 600; margin: var(--gap-xl) 0 var(--gap-sm); color: var(--app-text); }
    .table-section:first-child { margin-top: 0; }
    .vocab-table { width: 100%; border-collapse: collapse; font-size: var(--font-size-small); background: #fff; border-radius: 14px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .vocab-table th, .vocab-table td { border-bottom: 1px solid var(--color-border-faint); padding: var(--gap-md) var(--gap-lg); text-align: left; vertical-align: top; }
    .vocab-table th { background: var(--color-bg); color: var(--app-text-muted); font-weight: 600; }
    .vocab-table tbody tr:hover { background: rgba(0,0,0,0.02); }
    .level-badge { display: inline-block; padding: 0.25rem var(--gap-sm); border-radius: 4px; font-size: var(--font-size-caption); font-weight: 600; }
    .level-n1 { background: #fecaca; color: #b91c1c; }
    .level-n2 { background: #bfdbfe; color: #1d4ed8; }
    .vocab-cell-word { font-weight: 600; font-size: var(--font-size-body); }
    .vocab-cell-reading { font-size: var(--font-size-small); color: var(--color-text-muted); margin-top: 0.25rem; }
    .card-view-wrap { max-width: 480px; margin: 0 auto var(--gap-xl); }
    .flashcard { background: #fff; border: 1px solid var(--app-card-border); border-radius: 14px; min-height: 280px; cursor: pointer; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.3s; }
    .flashcard:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .flashcard .face { padding: var(--gap-xl); min-height: 260px; display: flex; flex-direction: column; justify-content: center; text-align: center; }
    .flashcard .face.front { align-items: center; }
    .flashcard .face.back { background: linear-gradient(135deg, var(--app-accent) 0%, #1D4ED8 100%); color: #fff; text-align: left; border-radius: var(--radius-md); }
    .flashcard .level { align-self: flex-start; margin-bottom: var(--gap-md); }
    .flashcard .main-text { font-size: 1.5rem; font-weight: 700; margin-bottom: var(--gap-sm); }
    .flashcard .sub-text { font-size: var(--font-size-body); color: var(--color-text-muted); }
    .flashcard .face.back .sub-text { color: rgba(255,255,255,0.9); }
    .flashcard .hint { font-size: var(--font-size-caption); color: var(--color-hint); margin-top: auto; padding-top: var(--gap-lg); }
    .flashcard .face.back .hint { color: rgba(255,255,255,0.8); }
    .pagination { display: flex; align-items: center; justify-content: center; gap: var(--gap-md); margin-top: var(--gap-lg); }
    .pagination button { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--color-border); background: #fff; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
    .pagination button:hover { background: var(--color-bg); }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination span { font-size: var(--font-size-small); color: var(--color-text-muted); }
    .actions-bottom { margin-top: var(--gap-xl); padding-top: var(--gap-lg); border-top: 1px solid var(--color-border-light); display: flex; gap: var(--gap-md); flex-wrap: wrap; }
    .actions-bottom .btn { padding: var(--gap-sm) var(--gap-lg); border-radius: var(--radius-md); font-size: var(--font-size-small); cursor: pointer; font-family: inherit; text-decoration: none; display: inline-block; border: 1px solid var(--color-border); background: #fff; color: var(--color-text); }
    .actions-bottom .btn:hover { background: var(--color-bg); }
    .actions-bottom .btn.primary { background: var(--app-accent); color: #fff; border-color: var(--app-accent); }
    .footer { text-align: center; padding: var(--gap-xl); font-size: var(--font-size-caption); color: var(--color-hint); }
    .view { display: none; }
    .view.active { display: block; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 10; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: #fff; padding: var(--gap-xl); border-radius: var(--radius-md); min-width: 260px; }
    .modal-content button { display: block; width: 100%; margin-top: 0.5rem; padding: 0.5rem; cursor: pointer; }
    .viewReview { padding: var(--gap-xl) 0; }
    #viewReview .pagination { flex-direction: column; align-items: center; }
    .btn-icon { width: 40px; height: 40px; border-radius: var(--radius-md); border: 1px solid var(--color-border); background: #fff; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; color: var(--color-text-muted); font-family: inherit; padding: 0; }
    .btn-icon:hover { background: var(--color-bg); color: var(--app-accent); }
    .btn-icon svg { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .card-nav .btn-icon { flex-shrink: 0; }
    @media (max-width: 768px) {
      .modal-content { max-width: min(400px, calc(100% - 2rem)); margin: 1rem; }
    }
  </style>
</head>
<body class="page-jp">
  <header class="header">
    <a href="index.html" class="brand">原子新闻</a>
    <nav class="nav-top">
      <a href="index.html">ホーム</a>
      <a href="digest.html">ニュース概要</a>
      <a href="podcast.html">ポッドキャスト台本</a>
      <a href="sync_reader.html">同期朗読</a>
      <a href="japanese_points.html" class="active">日本語学習</a>
    </nav>
    <span id="auth-header"></span>
  </header>
  <script src="/static/auth.js"></script>
  <main class="main">
    <div class="title-row">
      <h1 class="page-title">日本語学習</h1>
      <div class="view-tabs">
        <button type="button" id="btnList" class="active">一覧表</button>
        <button type="button" id="btnCard">新要点学习</button>
      </div>
    </div>
    <div class="toolbar-single">
      <button type="button" id="btnLoadLatest">最新を読み込む</button>
    </div>
    <div id="mainMessage" class="hint"></div>

    <div id="viewList" class="view active">
      <div class="list-wrap">
        <h2 class="table-section" id="sectionVocab">語彙 (N1-N2)</h2>
        <table class="vocab-table" id="tableVocab" style="display: none;">
          <thead><tr><th>レベル</th><th>語彙/読み</th><th>意味/解説</th><th>例文</th></tr></thead>
          <tbody id="tbodyVocab"></tbody>
        </table>
        <h2 class="table-section" id="sectionGrammar">文法 (N1-N2)</h2>
        <table class="vocab-table" id="tableGrammar" style="display: none;">
          <thead><tr><th>レベル</th><th>文法</th><th>意味/解説</th><th>例文</th></tr></thead>
          <tbody id="tbodyGrammar"></tbody>
        </table>
      </div>
      <div class="actions-bottom">
        <button type="button" id="btnNewLearn" class="btn primary">カード学習</button>
        <a href="#" id="btnReview" class="btn">温故知新</a>
      </div>
    </div>

    <div id="viewCard" class="view">
      <div class="card-view-wrap">
        <div class="flashcard" id="browseCard">
          <div class="face front" id="browseFront">
            <span class="level level-n2" id="browseLevel">N2</span>
            <div class="main-text" id="browseMain"></div>
            <div class="sub-text" id="browseSub"></div>
            <div class="hint">クリックして裏返す</div>
          </div>
          <div class="face back" id="browseBack" style="display: none;">
            <div class="main-text" id="browseBackMain"></div>
            <div class="sub-text" id="browseBackSub" style="white-space: pre-wrap;"></div>
            <div class="hint">クリックして表に戻す</div>
          </div>
        </div>
      </div>
      <div class="pagination">
        <div id="paginationBrowse">
          <button type="button" id="btnPrev" aria-label="前へ">&lt;</button>
          <span id="pageInfo">0 / 0</span>
          <button type="button" id="btnNext" aria-label="次へ">&gt;</button>
        </div>
        <div id="cardNewLearnWrap" style="display: none;">
          <span id="cardNewLearnMeta">0 / 0</span>
          <div class="card-nav" style="display: flex; gap: var(--gap-sm); flex-wrap: wrap; justify-content: center; margin-top: var(--gap-md);">
            <button type="button" id="btnCardFamiliar" class="btn-icon" aria-label="熟悉"><svg viewBox="0 0 24 24"><path d="M5 12l5 5L20 7"/></svg></button>
            <button type="button" id="btnCardUnfamiliar" class="btn-icon" aria-label="不熟悉"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
            <button type="button" id="btnCardEndNew" class="btn-icon" aria-label="结束"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="1"/></svg></button>
          </div>
        </div>
      </div>
      <div class="actions-bottom">
        <button type="button" id="btnNewLearn2" class="btn primary">カード学習</button>
        <a href="#" id="btnReview2" class="btn">温故知新</a>
      </div>
    </div>
  </main>

  <div id="modalChoice" class="modal">
    <div class="modal-content">
      <p>学習タイプを選択</p>
      <button type="button" data-mode="words">語彙</button>
      <button type="button" data-mode="grammar">文法</button>
    </div>
  </div>

  <div id="modalReviewLogin" class="modal">
    <div class="modal-content">
      <p>温故知新はログイン後に利用できます。</p>
      <a href="/login?next=/japanese_points.html" class="auth-btn-login">Login with Google</a>
      <button type="button" id="btnCloseReviewLogin" style="margin-top: 0.75rem;">閉じる</button>
    </div>
  </div>

  <div id="viewReview" class="view viewReview">
    <div class="card-view-wrap">
      <div class="flashcard" id="reviewCard">
        <div class="face front" id="reviewFront">
          <span class="level level-n2" id="reviewLevel">N2</span>
          <div class="main-text" id="reviewMain"></div>
          <div class="sub-text" id="reviewSub"></div>
          <div class="hint">クリックして裏返す</div>
        </div>
        <div class="face back" id="reviewBack" style="display: none;">
          <div class="main-text" id="reviewBackMain"></div>
          <div class="sub-text" id="reviewBackSub" style="white-space: pre-wrap;"></div>
          <div class="hint">クリックして表に戻す</div>
        </div>
      </div>
    </div>
    <div class="pagination">
      <span id="reviewPageInfo">0 / 0</span>
      <div class="card-nav" style="display: flex; gap: var(--gap-sm); flex-wrap: wrap; justify-content: center; margin-top: var(--gap-md);">
        <button type="button" id="btnReviewFamiliar" class="btn-icon" aria-label="熟悉"><svg viewBox="0 0 24 24"><path d="M5 12l5 5L20 7"/></svg></button>
        <button type="button" id="btnReviewUnfamiliar" class="btn-icon" aria-label="不熟悉"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
        <button type="button" id="btnEndReview" class="btn-icon" aria-label="结束"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="1"/></svg></button>
      </div>
    </div>
  </div>

  <footer class="footer">© 2026 Daily News Digest. All rights reserved.</footer>

  <script>
(function () {
  const API = "/api/review";
  const fetchOpts = { credentials: "same-origin" };
  let pointsData = null;
  let currentDate = "";
  let viewMode = "list";
  let catMode = "words";
  let cardSubMode = "browse";
  let browseIndex = 0;
  let newIndex = 0, newMode = "words", reviewItems = [], reviewIndex = 0, reviewMode = "words";

  function showReviewLoginModal() {
    document.getElementById("modalReviewLogin").classList.add("show");
  }
  function hideReviewLoginModal() {
    document.getElementById("modalReviewLogin").classList.remove("show");
  }

  function escapeHtml(s) {
    const div = document.createElement("div");
    div.textContent = s == null ? "" : s;
    return div.innerHTML;
  }

  function getCurrentList() {
    if (!pointsData) return [];
    return catMode === "words" ? (pointsData.words || []) : (pointsData.grammar || []);
  }

  function getLevel(item) {
    return (item && item.level) ? item.level : "N2";
  }

  function levelClass(l) {
    return l === "N1" ? "level-n1" : "level-n2";
  }

  function renderList() {
    const tbodyV = document.getElementById("tbodyVocab");
    const tbodyG = document.getElementById("tbodyGrammar");
    const tableV = document.getElementById("tableVocab");
    const tableG = document.getElementById("tableGrammar");
    tbodyV.innerHTML = "";
    tbodyG.innerHTML = "";
    const words = (pointsData && pointsData.words) ? pointsData.words : [];
    const grammar = (pointsData && pointsData.grammar) ? pointsData.grammar : [];
    var sectionV = document.getElementById("sectionVocab");
    var sectionG = document.getElementById("sectionGrammar");
    if (sectionV) sectionV.style.display = words.length ? "" : "none";
    if (sectionG) sectionG.style.display = grammar.length ? "" : "none";
    tableV.style.display = words.length ? "table" : "none";
    tableG.style.display = grammar.length ? "table" : "none";
    words.forEach(function (w) {
      const tr = document.createElement("tr");
      const level = getLevel(w);
      tr.innerHTML = "<td><span class=\"level-badge " + levelClass(level) + "\">" + escapeHtml(level) + "</span></td>" +
        "<td><div class=\"vocab-cell-word\">" + escapeHtml(w.word || "") + "</div><div class=\"vocab-cell-reading\">" + escapeHtml(w.hiragana || "") + "</div></td>" +
        "<td>" + escapeHtml(w.meaning_zh || "") + "</td>" +
        "<td>" + escapeHtml((w.example || "") + " " + (w.example_translation || "")) + "</td>";
      tbodyV.appendChild(tr);
    });
    grammar.forEach(function (g) {
      const tr = document.createElement("tr");
      const level = getLevel(g);
      tr.innerHTML = "<td><span class=\"level-badge " + levelClass(level) + "\">" + escapeHtml(level) + "</span></td>" +
        "<td>" + escapeHtml(g.grammar || "") + "</td>" +
        "<td>" + escapeHtml(g.meaning_zh || "") + "</td>" +
        "<td>" + escapeHtml((g.example1 || "") + " / " + (g.example1_translation || "")) + "<br>" + escapeHtml((g.example2 || "") + " / " + (g.example2_translation || "")) + "</td>";
      tbodyG.appendChild(tr);
    });
  }

  function renderBrowseCard() {
    const list = getCurrentList();
    const idx = browseIndex;
    const card = document.getElementById("browseCard");
    const front = document.getElementById("browseFront");
    const back = document.getElementById("browseBack");
    if (list.length === 0) {
      front.style.display = "flex";
      back.style.display = "none";
      document.getElementById("browseMain").textContent = "データがありません";
      document.getElementById("browseSub").textContent = "日付を選んで「読み込む」をクリック";
      document.getElementById("browseLevel").style.display = "none";
      document.getElementById("pageInfo").textContent = "0 / 0";
      document.getElementById("btnPrev").disabled = true;
      document.getElementById("btnNext").disabled = true;
      updateCardSubModeUI();
      return;
    }
    document.getElementById("btnPrev").disabled = idx <= 0;
    document.getElementById("btnNext").disabled = idx >= list.length - 1;
    document.getElementById("pageInfo").textContent = (idx + 1) + " / " + list.length;
    const item = list[idx];
    const level = getLevel(item);
    document.getElementById("browseLevel").textContent = level;
    document.getElementById("browseLevel").className = "level " + levelClass(level);
    document.getElementById("browseLevel").style.display = "block";
    if (catMode === "words") {
      document.getElementById("browseMain").textContent = item.word || "";
      document.getElementById("browseSub").textContent = item.hiragana || "";
      document.getElementById("browseBackMain").textContent = (item.meaning_zh || "");
      document.getElementById("browseBackSub").textContent = (item.example || "") + "\n" + (item.example_translation || "");
    } else {
      document.getElementById("browseMain").textContent = item.grammar || "";
      document.getElementById("browseSub").textContent = item.meaning_zh || "";
      document.getElementById("browseBackMain").textContent = item.meaning_zh || "";
      document.getElementById("browseBackSub").textContent = (item.example1 || "") + "\n" + (item.example1_translation || "") + "\n\n" + (item.example2 || "") + "\n" + (item.example2_translation || "");
    }
    front.style.display = "flex";
    back.style.display = "none";
    card.classList.remove("flipped");
    updateCardSubModeUI();
  }

  function updateCardSubModeUI() {
    const paginationBrowse = document.getElementById("paginationBrowse");
    const cardNewLearnWrap = document.getElementById("cardNewLearnWrap");
    if (cardSubMode === "browse") {
      if (paginationBrowse) paginationBrowse.style.display = "";
      if (cardNewLearnWrap) cardNewLearnWrap.style.display = "none";
    } else {
      if (paginationBrowse) paginationBrowse.style.display = "none";
      if (cardNewLearnWrap) cardNewLearnWrap.style.display = "block";
    }
  }

  function setBrowseFlipped(flip) {
    const card = document.getElementById("browseCard");
    const front = document.getElementById("browseFront");
    const back = document.getElementById("browseBack");
    if (flip) {
      front.style.display = "none";
      back.style.display = "block";
    } else {
      front.style.display = "flex";
      back.style.display = "none";
    }
  }

  document.getElementById("btnList").addEventListener("click", function () {
    viewMode = "list";
    document.getElementById("btnList").classList.add("active");
    document.getElementById("btnCard").classList.remove("active");
    document.getElementById("viewList").classList.add("active");
    document.getElementById("viewCard").classList.remove("active");
  });
  document.getElementById("btnCard").addEventListener("click", function () {
    viewMode = "card";
    document.getElementById("btnList").classList.remove("active");
    document.getElementById("btnCard").classList.add("active");
    document.getElementById("viewList").classList.remove("active");
    document.getElementById("viewCard").classList.add("active");
    renderBrowseCard();
  });
  async function loadLatest() {
    const messageEl = document.getElementById("mainMessage");
    messageEl.textContent = "読み込み中…";
    messageEl.className = "hint";
    try {
      const r = await fetch("/api/japanese_points/latest");
      if (!r.ok) {
        const err = await r.json().catch(function () { return {}; });
        throw new Error(err.error || "データがありません。python japanese_points.py を実行して要点データを生成してください。");
      }
      const data = await r.json();
      const date = data.report_date || "";
      pointsData = data;
      currentDate = date;
      const words = pointsData.words || [];
      const grammar = pointsData.grammar || [];
      browseIndex = 0;
      renderList();
      if (viewMode === "card") renderBrowseCard();
      messageEl.textContent = date ? ("最新: japanese_points_" + date + ".json を表示中。語彙 " + words.length + " 件、文法 " + grammar.length + " 件。") : ("語彙 " + words.length + " 件、文法 " + grammar.length + " 件を表示中。");
    } catch (e) {
      document.getElementById("mainMessage").textContent = e.message || "読み込みに失敗しました。";
      document.getElementById("mainMessage").className = "error";
    }
  }

  document.getElementById("browseCard").addEventListener("click", function () {
    const front = document.getElementById("browseFront");
    const back = document.getElementById("browseBack");
    if (front.style.display === "none") {
      front.style.display = "flex";
      back.style.display = "none";
    } else {
      front.style.display = "none";
      back.style.display = "block";
    }
  });
  document.getElementById("btnPrev").addEventListener("click", function () {
    if (browseIndex > 0) { browseIndex--; renderBrowseCard(); }
  });
  document.getElementById("btnNext").addEventListener("click", function () {
    const list = getCurrentList();
    if (browseIndex < list.length - 1) { browseIndex++; renderBrowseCard(); }
  });

  function showMain() {
    document.querySelector(".main").style.display = "";
    document.getElementById("viewReview").classList.remove("active");
  }
  function enterNewLearnInCardView(mode) {
    newMode = mode;
    if (!pointsData || !currentDate) {
      document.getElementById("mainMessage").textContent = "データがありません。ページを再読み込みするか、python japanese_points.py を実行してください。";
      document.getElementById("mainMessage").className = "error";
      return;
    }
    const arr = newMode === "words" ? (pointsData.words || []) : (pointsData.grammar || []);
    if (arr.length === 0) {
      document.getElementById("mainMessage").textContent = "この日付に" + (newMode === "words" ? "語彙" : "文法") + "がありません。";
      document.getElementById("mainMessage").className = "error";
      return;
    }
    if (viewMode !== "card") {
      viewMode = "card";
      document.getElementById("btnList").classList.remove("active");
      document.getElementById("btnCard").classList.add("active");
      document.getElementById("viewList").classList.remove("active");
      document.getElementById("viewCard").classList.add("active");
    }
    newIndex = 0;
    cardSubMode = "newLearn";
    updateCardSubModeUI();
    renderNewLearnCardInViewCard();
  }

  function renderNewLearnCardInViewCard() {
    const arr = newMode === "words" ? (pointsData.words || []) : (pointsData.grammar || []);
    const metaEl = document.getElementById("cardNewLearnMeta");
    const card = document.getElementById("browseCard");
    const front = document.getElementById("browseFront");
    const back = document.getElementById("browseBack");
    if (newIndex >= arr.length) {
      if (metaEl) metaEl.textContent = "終了しました。";
      if (card) card.style.visibility = "hidden";
      return;
    }
    if (card) card.style.visibility = "visible";
    if (metaEl) metaEl.textContent = (newIndex + 1) + " / " + arr.length;
    front.style.display = "flex";
    back.style.display = "none";
    card.classList.remove("flipped");
    const item = arr[newIndex];
    const level = getLevel(item);
    document.getElementById("browseLevel").textContent = level;
    document.getElementById("browseLevel").className = "level " + levelClass(level);
    document.getElementById("browseLevel").style.display = "block";
    if (newMode === "words") {
      document.getElementById("browseMain").textContent = item.word || "";
      document.getElementById("browseSub").textContent = item.hiragana || "";
      document.getElementById("browseBackMain").textContent = item.meaning_zh || "";
      document.getElementById("browseBackSub").textContent = (item.example || "") + "\n" + (item.example_translation || "");
    } else {
      document.getElementById("browseMain").textContent = item.grammar || "";
      document.getElementById("browseSub").textContent = item.meaning_zh || "";
      document.getElementById("browseBackMain").textContent = item.meaning_zh || "";
      document.getElementById("browseBackSub").textContent = (item.example1 || "") + "\n" + (item.example1_translation || "") + "\n\n" + (item.example2 || "") + "\n" + (item.example2_translation || "");
    }
  }

  function showReview(mode) {
    reviewMode = mode;
    document.querySelector(".main").style.display = "none";
    document.getElementById("viewReview").classList.add("active");
    loadReviewAndShow();
  }

  function renderReviewCard() {
    const pageInfo = document.getElementById("reviewPageInfo");
    const card = document.getElementById("reviewCard");
    const front = document.getElementById("reviewFront");
    const back = document.getElementById("reviewBack");
    if (reviewItems.length === 0) {
      if (pageInfo) pageInfo.textContent = "温故知新のデータがありません。";
      if (card) card.style.visibility = "hidden";
      return;
    }
    if (pageInfo) pageInfo.textContent = (reviewIndex + 1) + " / " + reviewItems.length;
    if (reviewIndex >= reviewItems.length) {
      if (pageInfo) pageInfo.textContent = "終了しました。";
      if (card) card.style.visibility = "hidden";
      return;
    }
    if (card) card.style.visibility = "visible";
    front.style.display = "flex";
    back.style.display = "none";
    card.classList.remove("flipped");
    const item = reviewItems[reviewIndex];
    const level = getLevel(item);
    document.getElementById("reviewLevel").textContent = level;
    document.getElementById("reviewLevel").className = "level " + levelClass(level);
    document.getElementById("reviewLevel").style.display = "block";
    if (reviewMode === "words") {
      document.getElementById("reviewMain").textContent = item.word || "";
      document.getElementById("reviewSub").textContent = item.hiragana || "";
      document.getElementById("reviewBackMain").textContent = item.meaning_zh || "";
      document.getElementById("reviewBackSub").textContent = (item.example || "") + "\n" + (item.example_translation || "");
    } else {
      document.getElementById("reviewMain").textContent = item.grammar || "";
      document.getElementById("reviewSub").textContent = item.meaning_zh || "";
      document.getElementById("reviewBackMain").textContent = item.meaning_zh || "";
      document.getElementById("reviewBackSub").textContent = (item.example1 || "") + "\n" + (item.example1_translation || "") + "\n\n" + (item.example2 || "") + "\n" + (item.example2_translation || "");
    }
  }

  async function loadReviewAndShow() {
    const url = reviewMode === "words" ? API + "/words" : API + "/grammar";
    try {
      const r = await fetch(url, fetchOpts);
      if (r.status === 401) {
        showReviewLoginModal();
        reviewItems = [];
        reviewIndex = 0;
        renderReviewCard();
        return;
      }
      reviewItems = await r.json();
      if (!Array.isArray(reviewItems)) reviewItems = [];
    } catch (e) {
      reviewItems = [];
    }
    try {
      const pr = await fetch(API + "/progress", fetchOpts);
      if (pr.status === 401) {
        reviewIndex = 0;
      } else {
        const prog = await pr.json();
        if (prog.mode === reviewMode && typeof prog.index === "number" && prog.index >= 0 && prog.index < reviewItems.length)
          reviewIndex = prog.index;
        else
          reviewIndex = 0;
      }
    } catch (_) {
      reviewIndex = 0;
    }
    renderReviewCard();
  }

  document.getElementById("btnNewLearn").addEventListener("click", function () {
    document.getElementById("modalChoice").classList.add("show");
    window._modalTarget = "new";
  });
  document.getElementById("btnNewLearn2").addEventListener("click", function () {
    document.getElementById("modalChoice").classList.add("show");
    window._modalTarget = "new";
  });
  document.getElementById("btnReview").addEventListener("click", function (e) {
    e.preventDefault();
    window._modalTarget = "review";
    fetch("/api/me", fetchOpts).then(function (r) { return r.json(); }).then(function (data) {
      if (data && data.logged_in) {
        document.getElementById("modalChoice").classList.add("show");
      } else {
        showReviewLoginModal();
      }
    }).catch(function () { showReviewLoginModal(); });
  });
  document.getElementById("btnReview2").addEventListener("click", function (e) {
    e.preventDefault();
    window._modalTarget = "review";
    fetch("/api/me", fetchOpts).then(function (r) { return r.json(); }).then(function (data) {
      if (data && data.logged_in) {
        document.getElementById("modalChoice").classList.add("show");
      } else {
        showReviewLoginModal();
      }
    }).catch(function () { showReviewLoginModal(); });
  });
  document.getElementById("btnCloseReviewLogin").addEventListener("click", function () {
    hideReviewLoginModal();
  });
  document.querySelectorAll("#modalChoice button[data-mode]").forEach(function (btn) {
    btn.addEventListener("click", function () {
      const mode = btn.getAttribute("data-mode");
      document.getElementById("modalChoice").classList.remove("show");
      if (window._modalTarget === "new") enterNewLearnInCardView(mode);
      else showReview(mode);
    });
  });

  document.getElementById("btnCardFamiliar").addEventListener("click", function () {
    newIndex++;
    fetch(API + "/progress", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ mode: newMode === "words" ? "words" : "grammar", index: newIndex }) }).catch(function () {});
    renderNewLearnCardInViewCard();
  });
  document.getElementById("btnCardUnfamiliar").addEventListener("click", async function () {
    const arr = newMode === "words" ? (pointsData.words || []) : (pointsData.grammar || []);
    if (newIndex >= arr.length) return;
    const item = arr[newIndex];
    const url = newMode === "words" ? API + "/words" : API + "/grammar";
    let list = [];
    try {
      const r = await fetch(url, fetchOpts);
      if (r.status === 401) {
        showReviewLoginModal();
        return;
      }
      list = await r.json();
      if (!Array.isArray(list)) list = [];
    } catch (_) {}
    list.push(item);
    const postRes = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(list), credentials: "same-origin" });
    if (postRes.status === 401) {
      showReviewLoginModal();
      return;
    }
    newIndex++;
    fetch(API + "/progress", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ mode: newMode === "words" ? "words" : "grammar", index: newIndex }), credentials: "same-origin" }).catch(function () {});
    renderNewLearnCardInViewCard();
  });
  document.getElementById("btnCardEndNew").addEventListener("click", function () {
    cardSubMode = "browse";
    renderBrowseCard();
  });

  document.getElementById("reviewCard").addEventListener("click", function () {
    const front = document.getElementById("reviewFront");
    const back = document.getElementById("reviewBack");
    if (front.style.display === "none") {
      front.style.display = "flex";
      back.style.display = "none";
    } else {
      front.style.display = "none";
      back.style.display = "block";
    }
  });
  document.getElementById("btnReviewFamiliar").addEventListener("click", async function () {
    if (reviewIndex >= reviewItems.length) return;
    reviewItems.splice(reviewIndex, 1);
    const url = reviewMode === "words" ? API + "/words" : API + "/grammar";
    const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(reviewItems), credentials: "same-origin" });
    if (res.status === 401) {
      showReviewLoginModal();
      return;
    }
    if (reviewIndex >= reviewItems.length) reviewIndex = Math.max(0, reviewItems.length - 1);
    fetch(API + "/progress", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ mode: reviewMode === "words" ? "words" : "grammar", index: reviewIndex }), credentials: "same-origin" }).catch(function () {});
    renderReviewCard();
  });
  document.getElementById("btnReviewUnfamiliar").addEventListener("click", function () {
    reviewIndex++;
    fetch(API + "/progress", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ mode: reviewMode === "words" ? "words" : "grammar", index: reviewIndex }), credentials: "same-origin" }).catch(function () {});
    renderReviewCard();
  });
  document.getElementById("btnEndReview").addEventListener("click", function () {
    showMain();
  });

  document.getElementById("btnLoadLatest").addEventListener("click", function () {
    loadLatest();
  });
  pointsData = null;
  currentDate = "";
  renderList();
  document.getElementById("mainMessage").textContent = "「最新を読み込む」をクリックしてデータを表示。";
})();
  </script>
</body>
</html>
